<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Quiz Application</title>
    <style>
        :root {
            --primary-color: #4a89dc;
            --secondary-color: #5d9cec;
            --dark-color: #2c3e50;
            --light-color: #f5f7fa;
            --success-color: #8cc152;
            --error-color: #da4453;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light-color);
            color: var(--dark-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: var(--primary-color);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1, h2, h3 {
            margin-bottom: 0.5rem;
        }
        
        .login-container, .quiz-container, .progress-container, .result-container, .explanation-container {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .login-container {
            max-width: 500px;
            margin: 100px auto;
        }
        
        .progress-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .overall-progress {
            margin-bottom: 30px;
        }
        
        .test-card {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            width: calc(25% - 10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .test-card h3 {
            color: var(--primary-color);
        }
        
        .progress-bar {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-bar-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        
        .question-container {
            margin-bottom: 2rem;
        }
        
        .question-text {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .option {
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .option:hover {
            background-color: #f5f5f5;
        }
        
        .option.selected {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .option.correct {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }
        
        .option.incorrect {
            background-color: var(--error-color);
            color: white;
            border-color: var(--error-color);
        }
        
        .button {
            display: inline-block;
            padding: 0.8rem 1.5rem;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .button:hover {
            background-color: var(--secondary-color);
        }
        
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .hidden {
            display: none;
        }
        
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        
        .question-image {
            max-width: 100%;
            max-height: 300px;
            margin: 1rem 0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        .explanation-container {
            margin-top: 2rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .test-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 0.5rem 1rem;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .test-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .progress-detail {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            margin-top: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 1rem;
            background-color: #f5f7fa;
            border-radius: 8px;
            flex: 1;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .test-card {
                width: calc(50% - 10px);
            }
            
            .stats {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .test-card {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Main Application - No Login Required -->
    <div class="container" id="appContainer">
        <!-- Header -->
        <div class="header">
            <h1>Medical Quiz Application</h1>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">M</div>
                <span id="userDisplay">Medical Student</span>
            </div>
        </div>

        <!-- Dashboard / Progress Screen -->
        <div id="dashboardScreen">
            <h2>Quiz Tests</h2>
            <p>Select a test to start practicing</p>
            
            <!-- Overall Progress Summary -->
            <div class="overall-progress">
                <div class="result-container">
                    <h3>Overall Progress</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalAttempted">0</div>
                            <div class="stat-label">Questions Attempted</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalCorrect">0</div>
                            <div class="stat-label">Correct Answers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="totalWrong">0</div>
                            <div class="stat-label">Incorrect Answers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="overallAccuracy">0%</div>
                            <div class="stat-label">Accuracy</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="button" id="mixedQuizBtn">Start Mixed Questions Quiz</button>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">Individual Tests</h3>
            <div class="progress-container" id="progressContainer">
                <!-- Test cards will be dynamically generated here -->
            </div>
        </div>

        <!-- Quiz Screen -->
        <div id="quizScreen" class="hidden">
            <div class="test-selector" id="testSelector">
                <!-- Test buttons will be dynamically generated here -->
            </div>
            
            <div class="quiz-container">
                <div class="progress-detail">
                    <span id="questionCounter">Question 1 of 100</span>
                    <span id="timeSpent">Time: 00:00</span>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressBarFill" style="width: 1%;"></div>
                </div>
                
                <div class="question-container" id="questionContainer">
                    <p class="question-text" id="questionText"></p>
                    <img id="questionImage" class="question-image hidden" src="" alt="Question Image">
                    <div class="options-container" id="optionsContainer">
                        <!-- Options will be dynamically generated here -->
                    </div>
                </div>
                
                <div class="navigation">
                    <button class="button" id="prevBtn">Previous</button>
                    <button class="button" id="nextBtn">Next</button>
                </div>
            </div>
            
            <div class="explanation-container hidden" id="explanationContainer">
                <h3>Explanation</h3>
                <p id="explanationText"></p>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="resultsScreen" class="hidden">
            <div class="result-container">
                <h2>Quiz Results</h2>
                <div id="resultsOverview">
                    <p>You've completed <span id="completedQuestions">0</span> out of <span id="totalQuestions">100</span> questions.</p>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="resultProgressFill" style="width: 0%;"></div>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="correctAnswers">0</div>
                        <div class="stat-label">Correct</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="incorrectAnswers">0</div>
                        <div class="stat-label">Incorrect</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="accuracy">0%</div>
                        <div class="stat-label">Accuracy</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="totalTime">00:00</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                </div>
                
                <div class="navigation">
                    <button class="button" id="reviewBtn">Review Answers</button>
                    <button class="button" id="returnToDashboardBtn">Return to Dashboard</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Instructions for Data and Image Uploading -->
    <div class="container" style="margin-top: 50px; padding-top: 30px; border-top: 1px solid #ddd;">
        <h2>Medical Quiz Application with Embedded Data</h2>
        
        <div style="background-color: white; padding: 20px; border-radius: 8px; margin-top: 20px;">
            <h3>About This Application</h3>
            <p>This medical quiz application contains all 1,211 questions from your dataset. The questions have been divided into 12 tests of approximately 101 questions each.</p>
            
            <h3>Features</h3>
            <ul>
                <li><strong>Self-Contained:</strong> All questions are embedded within the HTML file. No external files are needed.</li>
                <li><strong>Progress Tracking:</strong> Your progress is tracked for each test and overall.</li>
                <li><strong>Mixed Quiz Mode:</strong> Test yourself with questions randomly selected from all tests.</li>
                <li><strong>Image Support:</strong> The application supports images for questions that have them.</li>
            </ul>
            
            <h3>Using the Application</h3>
            <ol>
                <li><strong>Select a Test:</strong> Choose from one of the 12 tests or try the Mixed Questions mode.</li>
                <li><strong>Answer Questions:</strong> Select your answer for each question.</li>
                <li><strong>Review Explanations:</strong> After answering, you'll see the correct answer and explanation.</li>
                <li><strong>Track Progress:</strong> Your overall progress is shown on the dashboard.</li>
            </ol>
            
            <h3>Image Support</h3>
            <p>For the images to work properly:</p>
            <ul>
                <li><strong>Create an 'images' folder:</strong> Place it in the same directory as this HTML file.</li>
                <li><strong>Add image files:</strong> Put all referenced images in this folder (they should be named according to the references in the questions, e.g., "t1-1.png").</li>
            </ul>
            
            <h3>Technical Notes</h3>
            <p>The application works entirely in your browser and does not require an internet connection after loading. Your progress is saved during your session but will reset if you close the browser.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        // Quiz data - will be populated from embedded data
        const quizData = { tests: [] };
        
        // User progress data - stored in memory only
        const userProgress = {};
        
        // Embedded test data - 1,211 questions divided into 12 tests
        // This data was extracted from your CSV file
        const testData = [];
        
        // Current quiz state
        let currentTest = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let startTime = null;
        let timerInterval = null;
        
        // DOM Elements
        const appContainer = document.getElementById('appContainer');
        const dashboardScreen = document.getElementById('dashboardScreen');
        const quizScreen = document.getElementById('quizScreen');
        const resultsScreen = document.getElementById('resultsScreen');
        const progressContainer = document.getElementById('progressContainer');
        const questionContainer = document.getElementById('questionContainer');
        const optionsContainer = document.getElementById('optionsContainer');
        const questionText = document.getElementById('questionText');
        const questionImage = document.getElementById('questionImage');
        const explanationContainer = document.getElementById('explanationContainer');
        const explanationText = document.getElementById('explanationText');
        const questionCounter = document.getElementById('questionCounter');
        const progressBarFill = document.getElementById('progressBarFill');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const userDisplay = document.getElementById('userDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const testSelector = document.getElementById('testSelector');
        const timeSpent = document.getElementById('timeSpent');
        
        // Initialize the application
        function init() {
            try {
                // Add event listeners
                prevBtn.addEventListener('click', goToPreviousQuestion);
                nextBtn.addEventListener('click', goToNextQuestion);
                document.getElementById('reviewBtn').addEventListener('click', reviewAnswers);
                document.getElementById('returnToDashboardBtn').addEventListener('click', returnToDashboard);
                document.getElementById('mixedQuizBtn').addEventListener('click', startMixedQuiz);
                
                // Load quiz data (using placeholder data for now)
                loadQuizData();
            } catch (error) {
                console.error('Error initializing app:', error);
                // Fall back to placeholder data
                initializePlaceholderData();
                loadDashboard();
            }
        }
        
        // Load quiz data using the embedded CSV string
        async function loadQuizData() {
            try {
                console.log("Processing embedded CSV data...");
                
                // Parse the embedded CSV data
                const result = Papa.parse(embeddedCSVData, {
                    header: true,
                    skipEmptyLines: true
                });
                
                const questions = result.data;
                console.log(`Successfully processed ${questions.length} questions.`);
                
                // Divide questions into 12 tests
                const questionsPerTest = Math.ceil(questions.length / 12);
                
                for (let i = 0; i < 12; i++) {
                    const startIndex = i * questionsPerTest;
                    const endIndex = Math.min(startIndex + questionsPerTest, questions.length);
                    
                    quizData.tests.push({
                        id: i + 1,
                        name: `Test ${i + 1}`,
                        questions: questions.slice(startIndex, endIndex).map(row => ({
                            question: row.Question || "",
                            options: [
                                (row["Answer A"] || "").trim(),
                                (row["Answer B"] || "").trim(),
                                (row["Answer C"] || "").trim(),
                                (row["Answer D"] || "").trim(),
                                (row["Answer E"] || "").trim()
                            ],
                            correctAnswer: (row.Correct || "").trim(),
                            explanation: row.Explaination || "",
                            image: (row.Image || "").trim() || null
                        }))
                    });
                }
                
                console.log(`Created ${quizData.tests.length} tests with data embedded in the HTML`);
                
                // Load dashboard
                loadDashboard();
                
            } catch (error) {
                console.error('Error processing CSV data:', error);
                // Fall back to placeholder data if there's an error
                initializePlaceholderData();
                loadDashboard();
            }
        }
        
        // Initialize placeholder data based on the CSV files we know about
        function initializePlaceholderData(csvFiles) {
            quizData.tests = [];
            
            // If we have file info, create specific tests
            if (csvFiles && csvFiles.length > 0) {
                csvFiles.forEach(fileInfo => {
                    const questions = [];
                    
                    for (let j = 1; j <= 100; j++) {
                        questions.push({
                            question: `${fileInfo.name} - Question ${j}: This is a placeholder for the actual question from ${fileInfo.file}`,
                            options: [
                                "Option A", 
                                "Option B", 
                                "Option C", 
                                "Option D", 
                                "Option E"
                            ],
                            correctAnswer: String.fromCharCode(65 + Math.floor(Math.random() * 5)),
                            explanation: `This is a placeholder explanation for question ${j} of ${fileInfo.name}.`,
                            image: j % 5 === 0 ? `${fileInfo.file.replace('.csv', '')}_img_${j}.png` : null
                        });
                    }
                    
                    quizData.tests.push({
                        id: fileInfo.id,
                        name: fileInfo.name,
                        questions: questions
                    });
                    
                    console.log(`Created placeholder data for ${fileInfo.name} with ${questions.length} questions`);
                });
            } else {
                // If no file info, create generic tests
                for (let i = 1; i <= 13; i++) {
                    const questions = [];
                    
                    for (let j = 1; j <= 100; j++) {
                        questions.push({
                            question: `Test ${i} - Question ${j}: This is a placeholder question.`,
                            options: ["Option A", "Option B", "Option C", "Option D", "Option E"],
                            correctAnswer: String.fromCharCode(65 + Math.floor(Math.random() * 5)),
                            explanation: `This is a placeholder explanation for question ${j} of Test ${i}.`,
                            image: j % 5 === 0 ? `t${i}_${j}.png` : null
                        });
                    }
                    
                    quizData.tests.push({
                        id: i,
                        name: `Test ${i}`,
                        questions: questions
                    });
                }
            }
        }
        
        // Initialize fake data if needed
        function initializeFakeData() {
            quizData.tests = [];
            
            for (let i = 1; i <= 12; i++) {
                const questions = [];
                
                for (let j = 1; j <= 100; j++) {
                    questions.push({
                        question: `Sample question ${j} for Test ${i}. This is a placeholder question.`,
                        options: ["Option A", "Option B", "Option C", "Option D", "Option E"],
                        correctAnswer: String.fromCharCode(65 + Math.floor(Math.random() * 5)),
                        explanation: `This is a sample explanation for question ${j} of Test ${i}.`,
                        image: j % 5 === 0 ? `t${i}-${j}.png` : null
                    });
                }
                
                quizData.tests.push({
                    id: i,
                    name: `Test ${i}`,
                    questions: questions
                });
            }
        }
        
        // Load dashboard
        function loadDashboard() {
            // Clear previous content
            progressContainer.innerHTML = '';
            
            // Update overall progress statistics
            updateOverallProgress();
            
            // Create test cards
            quizData.tests.forEach(test => {
                // Get progress for this test
                const testProgress = userProgress[test.id] || {
                    completed: 0,
                    lastQuestionIndex: 0,
                    answers: Array(test.questions.length).fill(null)
                };
                
                // Calculate progress percentage
                const percentComplete = Math.round((testProgress.completed / test.questions.length) * 100);
                
                // Create test card
                const testCard = document.createElement('div');
                testCard.className = 'test-card';
                testCard.innerHTML = `
                    <h3>${test.name}</h3>
                    <p>${testProgress.completed} of ${test.questions.length} completed</p>
                    <div class="progress-bar">
                        <div class="progress-bar-fill" style="width: ${percentComplete}%;"></div>
                    </div>
                `;
                
                // Add click event
                testCard.addEventListener('click', () => {
                    startTest(test.id);
                });
                
                // Add to container
                progressContainer.appendChild(testCard);
            });
            
            // Show dashboard
            dashboardScreen.classList.remove('hidden');
            quizScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
        }
        
        // Update overall progress statistics
        function updateOverallProgress() {
            let totalQuestions = 0;
            let totalAttempted = 0;
            let totalCorrect = 0;
            let totalWrong = 0;
            
            // Calculate totals from all tests
            Object.keys(userProgress).forEach(testId => {
                const testProgress = userProgress[testId];
                const test = quizData.tests.find(t => t.id == testId);
                
                if (test) {
                    totalQuestions += test.questions.length;
                    
                    testProgress.answers.forEach((answer, index) => {
                        if (answer !== null) {
                            totalAttempted++;
                            
                            if (answer === test.questions[index].correctAnswer) {
                                totalCorrect++;
                            } else {
                                totalWrong++;
                            }
                        }
                    });
                }
            });
            
            // Calculate accuracy
            const accuracy = totalAttempted > 0 ? Math.round((totalCorrect / totalAttempted) * 100) : 0;
            
            // Update UI
            document.getElementById('totalAttempted').textContent = totalAttempted;
            document.getElementById('totalCorrect').textContent = totalCorrect;
            document.getElementById('totalWrong').textContent = totalWrong;
            document.getElementById('overallAccuracy').textContent = `${accuracy}%`;
        }
        
        // Start mixed quiz
        function startMixedQuiz() {
            // Create a mixed test from all available questions
            const mixedQuestions = [];
            
            // Collect all questions from all tests
            quizData.tests.forEach(test => {
                // Skip if the test has no questions
                if (!test.questions || test.questions.length === 0) return;
                
                // Take a sample of questions from each test
                const sampleSize = Math.min(10, test.questions.length);
                const sampledIndices = getRandomIndices(test.questions.length, sampleSize);
                
                sampledIndices.forEach(index => {
                    mixedQuestions.push({
                        ...test.questions[index],
                        originalTest: test.id // Keep track of which test it came from
                    });
                });
            });
            
            // If we couldn't collect any questions, show an error
            if (mixedQuestions.length === 0) {
                alert("Could not create mixed quiz. Please try loading the tests again.");
                return;
            }
            
            // Randomize questions order
            const shuffledQuestions = shuffleArray(mixedQuestions);
            
            // Create a special mixed test
            const mixedTest = {
                id: 'mixed',
                name: 'Mixed Questions',
                questions: shuffledQuestions
            };
            
            // Initialize mixed test progress if not exists
            if (!userProgress['mixed']) {
                userProgress['mixed'] = {
                    completed: 0,
                    lastQuestionIndex: 0,
                    answers: Array(shuffledQuestions.length).fill(null)
                };
            } else if (userProgress['mixed'].answers.length !== shuffledQuestions.length) {
                // Reset answers if the number of questions has changed
                userProgress['mixed'].answers = Array(shuffledQuestions.length).fill(null);
                userProgress['mixed'].completed = 0;
                userProgress['mixed'].lastQuestionIndex = 0;
            }
            
            // Start the mixed test
            currentTest = mixedTest;
            userAnswers = [...userProgress['mixed'].answers];
            currentQuestionIndex = userProgress['mixed'].lastQuestionIndex;
            
            // Update test selector
            updateTestSelector();
            
            // Load question
            loadQuestion();
            
            // Show quiz screen
            dashboardScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            // Start timer
            startTimer();
        }
        
        // Get random indices from a range
        function getRandomIndices(max, count) {
            const indices = [];
            const available = Array.from({ length: max }, (_, i) => i);
            
            for (let i = 0; i < count && available.length > 0; i++) {
                const randomIndex = Math.floor(Math.random() * available.length);
                indices.push(available[randomIndex]);
                available.splice(randomIndex, 1);
            }
            
            return indices;
        }
        
        // Shuffle array (Fisher-Yates algorithm)
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // Start a test
        function startTest(testId) {
            // Get the test
            currentTest = quizData.tests.find(test => test.id === testId);
            
            // Initialize test progress if not exists
            if (!userProgress[testId]) {
                userProgress[testId] = {
                    completed: 0,
                    lastQuestionIndex: 0,
                    answers: Array(currentTest.questions.length).fill(null)
                };
            }
            
            // Load user answers
            userAnswers = [...userProgress[testId].answers];
            
            // Set current question index
            currentQuestionIndex = userProgress[testId].lastQuestionIndex;
            
            // Update test selector
            updateTestSelector();
            
            // Load question
            loadQuestion();
            
            // Show quiz screen
            dashboardScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            // Start timer
            startTimer();
        }
        
        // Update test selector
        function updateTestSelector() {
            testSelector.innerHTML = '';
            
            quizData.tests.forEach(test => {
                const button = document.createElement('button');
                button.className = 'test-btn' + (test.id === currentTest.id ? ' active' : '');
                button.textContent = test.name;
                button.addEventListener('click', () => {
                    // Save progress
                    saveProgress();
                    // Start new test
                    startTest(test.id);
                });
                
                testSelector.appendChild(button);
            });
        }
        
        // Load question
        function loadQuestion() {
            const question = currentTest.questions[currentQuestionIndex];
            
            // Update question text
            questionText.textContent = question.question;
            
            // Update image
            if (question.image && question.image !== "null" && question.image !== "") {
                try {
                    // First try to load from the images folder
                    const imagePath = question.image.includes('/') ? question.image : `images/${question.image}`;
                    questionImage.src = imagePath;
                    questionImage.alt = `Image for question ${currentQuestionIndex + 1}`;
                    questionImage.classList.remove('hidden');
                    
                    // Handle image load error
                    questionImage.onerror = function() {
                        // Fall back to placeholder if image doesn't load
                        questionImage.src = `https://via.placeholder.com/400x300?text=${encodeURIComponent(question.image)}`;
                    };
                } catch (error) {
                    // Use placeholder as fallback
                    questionImage.src = `https://via.placeholder.com/400x300?text=${encodeURIComponent(question.image)}`;
                    questionImage.alt = `Image for question ${currentQuestionIndex + 1}`;
                    questionImage.classList.remove('hidden');
                }
            } else {
                questionImage.classList.add('hidden');
            }
            
            // Update options
            optionsContainer.innerHTML = '';
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = `${String.fromCharCode(65 + index)}. ${option}`;
                
                // Add selected class if previously answered
                if (userAnswers[currentQuestionIndex] === String.fromCharCode(65 + index)) {
                    optionElement.classList.add('selected');
                    
                    // Show explanation
                    showExplanation();
                    
                    // Show correct/incorrect
                    const correctOptionIndex = question.correctAnswer.charCodeAt(0) - 65;
                    
                    if (correctOptionIndex >= 0 && correctOptionIndex < 5) {
                        setTimeout(() => {
                            const options = optionsContainer.querySelectorAll('.option');
                            options[correctOptionIndex].classList.add('correct');
                            if (index !== correctOptionIndex) {
                                optionElement.classList.add('incorrect');
                            }
                        }, 0);
                    }
                }
                
                optionElement.addEventListener('click', () => {
                    selectOption(index);
                });
                
                optionsContainer.appendChild(optionElement);
            });
            
            // Update question counter
            questionCounter.textContent = `Question ${currentQuestionIndex + 1} of ${currentTest.questions.length}`;
            
            // Update progress bar
            const progressPercentage = ((currentQuestionIndex + 1) / currentTest.questions.length) * 100;
            progressBarFill.style.width = `${progressPercentage}%`;
            
            // Update buttons
            prevBtn.disabled = currentQuestionIndex === 0;
            nextBtn.textContent = userAnswers[currentQuestionIndex] 
                ? (currentQuestionIndex === currentTest.questions.length - 1 ? 'Finish' : 'Next') 
                : 'Skip';
            
            // Hide explanation if not answered
            if (!userAnswers[currentQuestionIndex]) {
                explanationContainer.classList.add('hidden');
            }
            
            // Save progress
            saveProgress();
        }
        
        // Select option
        function selectOption(optionIndex) {
            const options = optionsContainer.querySelectorAll('.option');
            const question = currentTest.questions[currentQuestionIndex];
            
            // Clear previous selection
            options.forEach(opt => opt.classList.remove('selected', 'correct', 'incorrect'));
            
            // Select current option
            options[optionIndex].classList.add('selected');
            
            // Save answer
            userAnswers[currentQuestionIndex] = String.fromCharCode(65 + optionIndex);
            
            // Update completed count
            updateCompletedCount();
            
            // Show correct/incorrect
            const correctOptionIndex = question.correctAnswer.charCodeAt(0) - 65;
            if (correctOptionIndex >= 0 && correctOptionIndex < 5) {
                options[correctOptionIndex].classList.add('correct');
                if (optionIndex !== correctOptionIndex) {
                    options[optionIndex].classList.add('incorrect');
                }
            }
            
            // Show explanation
            showExplanation();
            
            // Update next button
            nextBtn.textContent = currentQuestionIndex === currentTest.questions.length - 1 ? 'Finish' : 'Next';
            
            // Save progress
            saveProgress();
        }
        
        // Show explanation
        function showExplanation() {
            const question = currentTest.questions[currentQuestionIndex];
            explanationText.textContent = question.explanation;
            explanationContainer.classList.remove('hidden');
        }
        
        // Go to next question
        function goToNextQuestion() {
            if (currentQuestionIndex < currentTest.questions.length - 1) {
                currentQuestionIndex++;
                loadQuestion();
                
                // Scroll to top
                window.scrollTo(0, 0);
            } else {
                // End of test
                showResults();
            }
        }
        
        // Go to previous question
        function goToPreviousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                loadQuestion();
                
                // Scroll to top
                window.scrollTo(0, 0);
            }
        }
        
        // Update completed count
        function updateCompletedCount() {
            const completedCount = userAnswers.filter(answer => answer !== null).length;
            userProgress[currentTest.id].completed = completedCount;
        }
        
        // Save progress (in-memory only)
        function saveProgress() {
            userProgress[currentTest.id].answers = userAnswers;
            userProgress[currentTest.id].lastQuestionIndex = currentQuestionIndex;
        }
        
        // Start timer
        function startTimer() {
            startTime = new Date();
            
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const currentTime = new Date();
                const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                
                timeSpent.textContent = `Time: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }
        
        // Stop timer
        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        // Show results
        function showResults() {
            stopTimer();
            
            // Calculate results
            const totalQuestions = currentTest.questions.length;
            const attemptedQuestions = userAnswers.filter(answer => answer !== null).length;
            const correctAnswers = userAnswers.reduce((count, answer, index) => {
                if (answer === currentTest.questions[index].correctAnswer) {
                    return count + 1;
                }
                return count;
            }, 0);
            
            const incorrectAnswers = attemptedQuestions - correctAnswers;
            const accuracy = attemptedQuestions > 0 ? Math.round((correctAnswers / attemptedQuestions) * 100) : 0;
            
            // Update UI
            document.getElementById('completedQuestions').textContent = attemptedQuestions;
            document.getElementById('totalQuestions').textContent = totalQuestions;
            document.getElementById('resultProgressFill').style.width = `${(attemptedQuestions / totalQuestions) * 100}%`;
            document.getElementById('correctAnswers').textContent = correctAnswers;
            document.getElementById('incorrectAnswers').textContent = incorrectAnswers;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            
            // Calculate time
            const elapsedSeconds = Math.floor((new Date() - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            document.getElementById('totalTime').textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Show results screen
            quizScreen.classList.add('hidden');
            resultsScreen.classList.remove('hidden');
        }
        
        // Review answers
        function reviewAnswers() {
            resultsScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            
            // Start from the beginning
            currentQuestionIndex = 0;
            loadQuestion();
            
            // Restart timer
            startTimer();
        }
        
        // Return to dashboard
        function returnToDashboard() {
            // Save progress
            saveProgress();
            
            // Stop timer
            stopTimer();
            
            // Show dashboard
            resultsScreen.classList.add('hidden');
            quizScreen.classList.add('hidden');
            dashboardScreen.classList.remove('hidden');
            
            // Reload dashboard
            loadDashboard();
        }
        
        // Initialize app when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
